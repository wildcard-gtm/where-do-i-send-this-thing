generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("SUPABASE_DB_URL")
  directUrl = env("SUPABASE_DB_URL_DIRECT")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  password          String
  name              String
  role              String             @default("user")
  autoProcess       Boolean            @default(false)
  createdAt         DateTime           @default(now())
  batches           Batch[]
  contacts          Contact[]
  feedbacks         Feedback[]
  enrichmentBatches EnrichmentBatch[]
  postcardBatches   PostcardBatch[]
}

model Batch {
  id        String   @id @default(cuid())
  name      String?
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  jobs      Job[]
}

model Job {
  id             String       @id @default(cuid())
  batchId        String
  batch          Batch        @relation(fields: [batchId], references: [id])
  linkedinUrl    String
  personName     String?
  status         String       @default("pending")
  recommendation String?
  confidence     Int?
  result         String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  events         AgentEvent[]
  contact        Contact?
}

model AgentEvent {
  id        String   @id @default(cuid())
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id])
  type      String
  iteration Int?
  data      String
  createdAt DateTime @default(now())
}

model Contact {
  id                  String               @id @default(cuid())
  userId              String
  user                User                 @relation(fields: [userId], references: [id])
  name                String
  email               String?
  linkedinUrl         String
  company             String?
  title               String?
  profileImageUrl     String?
  careerSummary       String?
  homeAddress         String?
  officeAddress       String?
  recommendation      String?
  confidence          Int?
  lastScannedAt       DateTime?
  notes               String?
  jobId               String?              @unique
  job                 Job?                 @relation(fields: [jobId], references: [id])
  chatMessages        ChatMessage[]
  feedbacks           Feedback[]
  companyEnrichments  CompanyEnrichment[]
  revisions           ContactRevision[]
  postcards           Postcard[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
}

model ChatMessage {
  id        String   @id @default(cuid())
  contactId String
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  role      String
  content   String
  createdAt DateTime @default(now())
}

model SystemPrompt {
  id        String   @id @default(cuid())
  key       String   @unique
  label     String
  content   String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model Feedback {
  id        String   @id @default(cuid())
  contactId String
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  rating    String
  comment   String?
  createdAt DateTime @default(now())
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String
  message   String
  createdAt DateTime @default(now())
}

model PostcardBatch {
  id        String     @id @default(cuid())
  name      String?
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  status    String     @default("running") // "running" | "complete" | "failed" | "cancelled"
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  postcards Postcard[]
}

model EnrichmentBatch {
  id          String              @id @default(cuid())
  name        String?
  userId      String
  user        User                @relation(fields: [userId], references: [id])
  status      String              @default("running") // "running" | "complete" | "failed"
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  enrichments CompanyEnrichment[]
}

model CompanyEnrichment {
  id                String           @id @default(cuid())
  contactId         String
  contact           Contact          @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Enrichment batch (optional — older records may not have this)
  enrichmentBatchId String?
  enrichmentBatch   EnrichmentBatch? @relation(fields: [enrichmentBatchId], references: [id])

  // Revision tracking
  revisionNumber   Int      @default(1)
  isLatest         Boolean  @default(true)

  // Enriched company data
  companyName      String
  companyWebsite   String?
  companyLogo      String?  // URL to logo image

  // Open roles (stored as JSON array)
  openRoles        Json?    // [{ title: string, location: string, level: string, url?: string }]

  // Company culture
  companyValues    Json?    // ["value1", "value2", ...]
  companyMission   String?

  // Locations
  officeLocations  Json?    // ["City, State", ...]

  // Team member photos (stored as JSON array)
  teamPhotos       Json?    // [{ name?: string, photoUrl: string, title?: string }]

  // Metadata
  enrichmentStatus String   @default("pending") // "pending" | "enriching" | "completed" | "failed"
  currentStep      String?  // e.g. "Identifying company", "Fetching logo", "Searching open roles"
  errorMessage     String?
  retryCount       Int      @default(0) // number of attempts made so far (max 5)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([contactId, revisionNumber])
  @@index([contactId, isLatest])
}

model ContactRevision {
  id                String   @id @default(cuid())
  contactId         String
  contact           Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Revision tracking
  revisionNumber    Int
  isLatest          Boolean  @default(false)

  // Snapshot of contact data at this revision
  name              String
  email             String?
  linkedinUrl       String
  company           String?
  title             String?
  profileImageUrl   String?
  careerSummary     String?
  homeAddress       String?
  officeAddress     String?
  recommendation    String?
  confidence        Int?

  // Job data snapshot (for context)
  jobResult         String?  // JSON string of full job result

  createdAt         DateTime @default(now())

  @@index([contactId, revisionNumber])
  @@index([contactId, isLatest])
}

model Postcard {
  id               String   @id @default(cuid())
  contactId        String
  contact          Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Postcard batch (optional — older records may not have this)
  postcardBatchId  String?
  postcardBatch    PostcardBatch? @relation(fields: [postcardBatchId], references: [id])

  template         String   // "warroom" | "zoom"
  status           String   @default("pending") // "pending" | "generating" | "ready" | "approved" | "failed" | "cancelled"
  errorMessage     String?
  retryCount       Int      @default(0) // number of generation attempts made (max 5)

  // Generated images (relative paths under /public/postcards/)
  backgroundUrl    String?  // AI-generated background scene
  backgroundPrompt String?  // prompt used (for regeneration)
  imageUrl         String?  // final composited PNG

  // Data snapshot used at generation time
  companyLogo      String?
  openRoles        Json?    // [{ title, location, level }]
  companyValues    Json?    // ["value1", ...]
  companyMission   String?
  officeLocations  Json?    // ["NYC", "London", ...]
  contactName      String
  contactTitle     String?
  contactPhoto     String?
  deliveryAddress  String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([contactId])
  @@index([status])
}
